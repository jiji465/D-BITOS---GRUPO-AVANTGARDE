<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Débitos | Sete Soluções</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e40af; --secondary: #3b82f6; --background: #f1f5f9; --card-bg: #ffffff;
            --text-primary: #111827; --text-secondary: #6b7280; --danger: #ef4444; --success: #22c55e;
            --warning: #f59e0b; --border-color: #e5e7eb;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .sidebar { background-color: var(--card-bg); border-right: 1px solid var(--border-color); }
        .kpi-card { background: var(--card-bg); border-radius: 0.75rem; box-shadow: 0 4px 12px -1px rgba(0,0,0,0.05); transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px -3px rgba(0,0,0,0.07); }
        .chart-card { background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: 0 4px 12px -1px rgba(0,0,0,0.05); padding: 1.5rem; border: 1px solid var(--border-color); }
        .table-container { border-radius: 0 0 0.75rem 0.75rem; overflow: hidden; border: 1px solid var(--border-color); border-top: none; }
        .table-header th { background-color: #f9fafb; color: var(--text-secondary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 600; cursor: pointer; user-select: none; }
        .table-row:hover { background-color: #f3f4f6; }
        .filter-bar { background-color: #ffffff; padding: 1rem 1.5rem; border-radius: 0.75rem 0.75rem 0 0; border: 1px solid var(--border-color); box-shadow: 0 4px 12px -1px rgba(0,0,0,0.05); }
        .filter-input { background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 0.5rem; transition: all 0.2s ease; }
        .filter-input:focus { background-color: #ffffff; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.2); outline: none; }
        .sort-icon { opacity: 0.4; transition: all 0.2s ease-in-out; }
        .sort-icon.active { opacity: 1; color: var(--primary); }
        .tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .app-header { background-image: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.90)); box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
        .sidebar label { border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.2s ease; }
        .sidebar label:hover { background-color: #eff6ff; }
        .sidebar input[type="checkbox"] { accent-color: var(--primary); }
        .filter-grid { display: grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap: 0.75rem; align-items: end; }
        .filter-field { grid-column: span 4 / span 4; min-width: 200px; }
        .filter-label { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: .04em; }
        .filter-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 1.25rem; height: 1.25rem; padding: 0 0.35rem; border-radius: 9999px; background: #e5edff; color: #1e40af; font-size: 0.7rem; font-weight: 700; }
        .filter-actions { grid-column: span 4 / span 4; display: flex; gap: 0.5rem; justify-content: flex-end; }
        .loading { opacity: 0.6; pointer-events: none; }
        .tooltip { position: relative; }
        .tooltip:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; white-space: nowrap; z-index: 50; }
        .export-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; }
        .export-btn:hover { background: linear-gradient(135deg, #059669, #047857); }
        .table-row:nth-child(even) { background-color: #f9fafb; }
        .table-row:nth-child(odd) { background-color: #ffffff; }
        .notification { position: fixed; top: 1rem; right: 1rem; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #10b981; }
        .notification.error { background: #ef4444; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside id="sidebar" class="sidebar w-72 flex-shrink-0 p-4 flex flex-col">
        <div class="flex items-center gap-3 mb-10 px-2">
            <div class="bg-blue-100 p-2 rounded-lg"><i data-lucide="shield-check" class="text-blue-800"></i></div>
            <h2 class="text-xl font-bold text-gray-800">Sete Soluções</h2>
        </div>
        <nav id="company-filters" class="flex flex-col gap-2 flex-1">
             <h3 class="text-sm font-semibold text-gray-400 uppercase px-3 mt-4 mb-2">Empresas</h3>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col">
        <header class="app-header backdrop-blur-sm border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-20">
             <h1 id="header-title" class="text-2xl font-bold text-gray-800">Débitos Fiscais</h1>
             <div class="flex items-center gap-3">
                 <button id="export-btn" class="export-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 tooltip" data-tooltip="Exportar dados filtrados">
                     <i data-lucide="download" class="w-4 h-4 mr-2"></i>Exportar
                 </button>
                 <button id="refresh-btn" class="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition tooltip" data-tooltip="Atualizar dados">
                     <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                 </button>
             </div>
        </header>
        
        <div class="px-8 border-b border-gray-200 bg-white/95 backdrop-blur-sm sticky top-[73px] z-10">
            <nav class="flex gap-4">
                <button class="tab-button active" data-tab="debitos">Débitos Fiscais</button>
            </nav>
        </div>

        <main class="flex-1 p-8">
            <div id="debitos-content" class="tab-content">
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="kpi-card p-6"><div class="flex items-center justify-between"><h3 class="font-semibold text-gray-500 uppercase">Dívida Total</h3><div class="bg-orange-100 p-2 rounded-md"><i data-lucide="landmark" class="text-orange-600"></i></div></div><p id="kpi-total" class="text-4xl font-bold text-orange-600 mt-2">R$ 0,00</p></div>
                    <div class="kpi-card p-6"><div class="flex items-center justify-between"><h3 class="font-semibold text-gray-500 uppercase">Dívida Vencida</h3><div class="bg-red-100 p-2 rounded-md"><i data-lucide="alert-circle" class="text-red-600"></i></div></div><p id="kpi-vencido" class="text-4xl font-bold text-red-600 mt-2">R$ 0,00</p></div>
                    <div class="kpi-card p-6"><div class="flex items-center justify-between"><h3 class="font-semibold text-gray-500 uppercase">A Vencer</h3><div class="bg-yellow-100 p-2 rounded-md"><i data-lucide="calendar-check" class="text-yellow-600"></i></div></div><p id="kpi-avencer" class="text-4xl font-bold text-yellow-600 mt-2">R$ 0,00</p></div>
                    <div class="kpi-card p-6"><div class="flex items-center justify-between"><h3 class="font-semibold text-gray-500 uppercase">Dívida Vencida (%)</h3><div class="bg-red-100 p-2 rounded-md"><i data-lucide="pie-chart" class="text-red-600"></i></div></div><p id="kpi-perc-vencido" class="text-4xl font-bold text-red-600 mt-2">0%</p></div>
                </section>
                <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                    <div class="chart-card lg:col-span-2 flex flex-col"><h3 class="text-lg font-bold text-gray-800 mb-4">Composição da Dívida</h3><div class="relative h-96"><canvas id="debtByTypeChart"></canvas></div></div>
                    <div class="chart-card lg:col-span-3 flex flex-col"><h3 class="text-lg font-bold text-gray-800 mb-4">Dívida por Empresa</h3><div class="relative h-96"><canvas id="debtByCompanyChart"></canvas></div></div>
                </section>
                <section>
                    <div class="filter-bar">
                        <div class="flex items-center justify-between mb-3"><h3 class="text-xl font-bold text-gray-800">Detalhamento dos Débitos</h3></div>
                        <div class="filter-grid">
                            <div class="filter-field">
                                <label class="filter-label"><i data-lucide="calendar" class="w-4 h-4"></i> Início Venc.</label>
                                <input type="date" id="start-date-filter" class="filter-input p-2 w-full tooltip" data-tooltip="Data de vencimento inicial para filtrar débitos">
                            </div>
                            <div class="filter-field">
                                <label class="filter-label"><i data-lucide="calendar" class="w-4 h-4"></i> Fim Venc.</label>
                                <input type="date" id="end-date-filter" class="filter-input p-2 w-full tooltip" data-tooltip="Data de vencimento final para filtrar débitos">
                            </div>
                            <div class="filter-field">
                                <label class="filter-label"><i data-lucide="filter" class="w-4 h-4"></i> Situação <span id="badge-situacao" class="filter-badge">0</span></label>
                                <select id="filter-situacao" multiple class="filter-input p-2 w-full tooltip" data-tooltip="Selecione uma ou mais situações"></select>
                            </div>
                             <div class="filter-actions">
                                <button id="clear-filters-btn" class="px-3 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition tooltip" data-tooltip="Limpar todos os filtros aplicados">Limpar</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container bg-white"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr class="bg-gray-50"><th class="px-6 py-4" data-sort-key="nomeDebito"><div class="flex items-center gap-2">Débito<span class="sort-icon"></span></div></th><th class="px-6 py-4" data-sort-key="competencia"><div class="flex items-center gap-2">Competência<span class="sort-icon"></span></div></th><th class="px-6 py-4" data-sort-key="vencimento"><div class="flex items-center gap-2">Vencimento<span class="sort-icon"></span></div></th><th class="px-6 py-4" data-sort-key="situacao"><div class="flex items-center gap-2">Situação<span class="sort-icon"></span></div></th><th class="px-6 py-4 text-right" data-sort-key="valor"><div class="flex items-center justify-end gap-2">Valor<span class="sort-icon"></span></div></th></tr></thead><tbody id="debt-table-body"></tbody></table></div></div>
                </section>
            </div>
        </main>
    </div>
    
 <script>
        // =================================================================================
        // BASE DE DADOS
        // =================================================================================
        const debitosDataRaw = [
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (3ª Quota)', competencia: '1º trimestre', vencimento: '30/06/2025', valor: 'R$ 6.384,93', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 25.225,31', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 22.988,35', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'CSLL Demais (2ª Quota)', competencia: '1º trimestre', vencimento: '30/05/2025', valor: 'R$ 3.307,78', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'CSLL Demais (3ª Quota)', competencia: '1º trimestre', vencimento: '30/06/2025', valor: 'R$ 3.307,78', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'CSLL Demais (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 9.954,34', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'ISS (DIVIDA ATIVA)', competencia: '03/2022', vencimento: '18/04/2022', valor: 'R$ 4.055,42', situacao: 'Vencido', tipo: 'ISS' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'CSLL Demais (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 9.071,58', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 22.338,92', situacao: 'A vencer', tipo: 'IRPJ' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'ISS', competencia: '08/2025', vencimento: '15/09/2025', valor: 'R$ 7.288,53', situacao: 'A vencer', tipo: 'ISS' },
            { empresa: 'AGUIAR DUARTE SERVICOS MEDICOS LTDA - (SC)', nomeDebito: 'CSLL Demais (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 8.815,31', situacao: 'A vencer', tipo: 'CSLL' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (1ª Quota)', competencia: '1º trimestre', vencimento: '31/07/2025', valor: 'R$ 10.512,04', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 9.579,82', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'CSLL Demais (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 4.614,94', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'CSLL Demais (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 4.205,66', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'IRPJ Lucro Presumido (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 9.309,19', situacao: 'A vencer', tipo: 'IRPJ' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'CSLL Demais (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 4.086,85', situacao: 'A vencer', tipo: 'CSLL' },
            { empresa: 'AVANT SPA LTDA - (SC)', nomeDebito: 'ISS', competencia: '08/2025', vencimento: '15/09/2025', valor: 'R$ 1.608,51', situacao: 'A vencer', tipo: 'ISS' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'Parcelamento ISS (R$ 62.692,22)', competencia: '01/12 parcelas', vencimento: '15/09/2025', valor: 'R$ 5.224,35', situacao: 'A vencer', tipo: 'Parcelamento' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'IRPJ Lucro Presumido (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 35.808,62', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'IRPJ Lucro Presumido (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 32.633,15', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'CSLL Demais (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 13.920,68', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'CSLL Demais (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 12.686,21', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'IRPJ Lucro Presumido (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 31.711,24', situacao: 'A vencer', tipo: 'IRPJ' },
            { empresa: 'AVANTGARDE CURSOS LTDA - (SP)', nomeDebito: 'CSLL Demais (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 12.327,82', situacao: 'A vencer', tipo: 'CSLL' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'IRPJ Lucro Presumido (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 22.421,01', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'IRPJ Lucro Presumido (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 20.432,71', situacao: 'Vencido', tipo: 'IRPJ' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'CSLL Demais (1ª Quota)', competencia: '2º trimestre', vencimento: '31/07/2025', valor: 'R$ 10.245,99', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'CSLL Demais (2ª Quota)', competencia: '2º trimestre', vencimento: '29/08/2025', valor: 'R$ 9.337,36', situacao: 'Vencido', tipo: 'CSLL' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'IRPJ Lucro Presumido (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 19.855,48', situacao: 'A vencer', tipo: 'IRPJ' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'CSLL Demais (3ª Quota)', competencia: '2º trimestre', vencimento: '30/09/2025', valor: 'R$ 9.073,58', situacao: 'A vencer', tipo: 'CSLL' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'Parcelamento (Salvdo Devedor R$ 48.465,67)', competencia: '14/34 parcelas', vencimento: '30/09/2025', valor: 'R$ 9.693,13', situacao: 'A vencer', tipo: 'Parcelamento' },
            { empresa: 'INSTITUTO DE FISIOLOGIA HUMANA LTDA (SP)', nomeDebito: 'Parcelamento (Salvdo Devedor R$ 12.230,84)', competencia: '02/6 parcelas', vencimento: '30/09/2025', valor: 'R$ 582,40', situacao: 'A vencer', tipo: 'Parcelamento' }
        ];

        // =================================================================================
        // LÓGICA DO DASHBOARD
        // =================================================================================
        const state = { activeCompanies: new Set(), debitosSort: { key: 'vencimento', dir: 'asc' } };
        const charts = {};
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const parseCurrency = (str) => typeof str === 'string' ? parseFloat(str.replace(/[^0-9,-]+/g,"").replace(/\./g,'').replace(',', '.')) : str;
        const parseDebitosDate = (d) => { const [day, month, year] = d.split('/'); return new Date(year, month - 1, day); };
        const getMultiValues = (selectId) => { const el = document.getElementById(selectId); return Array.from(el.selectedOptions).map(o => o.value); };
        
        const updateFilterBadges = () => {
            const safeLen = (id) => { const el = document.getElementById(id); return el ? Array.from(el.selectedOptions).length : 0; };
            const setBadge = (badgeId, value) => { const b = document.getElementById(badgeId); if (b) b.textContent = value; };
            setBadge('badge-situacao', safeLen('filter-situacao'));
        };

        const debitosData = debitosDataRaw.map(d => ({...d, valor: parseCurrency(d.valor), empresa: d.empresa.replace(/ - \(\w+\)/, '').trim() }));

        const updateAll = () => {
            const companyFilter = (d) => state.activeCompanies.size === 0 || state.activeCompanies.has(d.empresa);
            const debitos = debitosData.filter(companyFilter);
            updateDebitos(debitos);
            updateFilterBadges();
        };

        const updateDebitos = (data) => {
            const situacoes = getMultiValues('filter-situacao');
            const startDate = document.getElementById('start-date-filter').value ? new Date(document.getElementById('start-date-filter').value + 'T00:00:00') : null;
            const endDate = document.getElementById('end-date-filter').value ? new Date(document.getElementById('end-date-filter').value + 'T23:59:59') : null;
            
            const filtered = data.filter(d => 
                (!startDate || parseDebitosDate(d.vencimento) >= startDate) && 
                (!endDate || parseDebitosDate(d.vencimento) <= endDate) && 
                (situacoes.length === 0 || situacoes.includes(d.situacao))
            );

            const dividaTotal = filtered.reduce((sum, item) => sum + item.valor, 0);
            const dividaVencida = filtered.filter(d => d.situacao === 'Vencido').reduce((sum, item) => sum + item.valor, 0);
            const dividaAVencer = dividaTotal - dividaVencida;

            document.getElementById('kpi-total').textContent = formatCurrency(dividaTotal);
            document.getElementById('kpi-vencido').textContent = formatCurrency(dividaVencida);
            document.getElementById('kpi-avencer').textContent = formatCurrency(dividaAVencer);
            document.getElementById('kpi-perc-vencido').textContent = dividaTotal > 0 ? `${((dividaVencida / dividaTotal) * 100).toFixed(0)}%` : '0%';

            const byType = filtered.reduce((acc, d) => { acc[d.tipo] = (acc[d.tipo] || 0) + d.valor; return acc; }, {});
            charts.debtByType.data.labels = Object.keys(byType);
            charts.debtByType.data.datasets[0].data = Object.values(byType);
            charts.debtByType.update();

            const byCompany = filtered.reduce((acc, { empresa, situacao, valor }) => {
                if (!acc[empresa]) acc[empresa] = { vencido: 0, aVencer: 0 };
                if (situacao === 'Vencido') acc[empresa].vencido += valor; else acc[empresa].aVencer += valor;
                return acc;
            }, {});
            charts.debtByCompany.data.labels = Object.keys(byCompany);
            charts.debtByCompany.data.datasets[0].data = Object.values(byCompany).map(d => d.vencido);
            charts.debtByCompany.data.datasets[1].data = Object.values(byCompany).map(d => d.aVencer);
            charts.debtByCompany.update();
            
            const tableBody = document.getElementById('debt-table-body');
            const sorted = filtered.sort((a, b) => {
                const key = state.debitosSort.key;
                let aVal = a[key];
                let bVal = b[key];
                if (key === 'vencimento') { aVal = parseDebitosDate(a.vencimento); bVal = parseDebitosDate(b.vencimento); }
                if (key === 'valor') { aVal = a.valor; bVal = b.valor; }
                if (aVal > bVal) return state.debitosSort.dir === 'asc' ? 1 : -1;
                if (aVal < bVal) return state.debitosSort.dir === 'asc' ? -1 : 1;
                return 0;
            });
            tableBody.innerHTML = sorted.map(d => `<tr class="table-row border-b"><td class="px-6 py-4 font-semibold">${d.nomeDebito}</td><td class="px-6 py-4">${d.competencia}</td><td class="px-6 py-4">${d.vencimento}</td><td class="px-6 py-4"><span class="px-2.5 py-1 text-xs font-semibold rounded-full ${d.situacao === 'Vencido' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${d.situacao}</span></td><td class="px-6 py-4 text-right font-bold">${formatCurrency(d.valor)}</td></tr>`).join('');
        };
        
        const setupEventListeners = () => {
            document.querySelectorAll('#start-date-filter, #end-date-filter, #filter-situacao').forEach(el => el.addEventListener('change', () => { updateAll(); }));
            document.getElementById('clear-filters-btn').addEventListener('click', () => { 
                document.getElementById('start-date-filter').value = ''; 
                document.getElementById('end-date-filter').value = ''; 
                document.getElementById('filter-situacao').selectedIndex = -1;
                updateAll(); 
            });
            document.querySelectorAll('#debitos-content .table-header th').forEach(th => th.addEventListener('click', () => { 
                const key = th.dataset.sortKey; 
                if (key) { 
                    state.debitosSort.dir = state.debitosSort.key === key && state.debitosSort.dir === 'asc' ? 'desc' : 'asc'; 
                    state.debitosSort.key = key; 
                    updateAll(); 
                }
            }));
        };

        const updateSidebar = () => {
            const companies = [...new Set(debitosData.map(d => d.empresa))];
            if (state.activeCompanies.size === 0) companies.forEach(c => state.activeCompanies.add(c));
            
            const filtersContainer = document.getElementById('company-filters');
            filtersContainer.innerHTML = `<h3 class="text-sm font-semibold text-gray-400 uppercase px-3 mt-4 mb-2">Empresas</h3>` +
                `<label class="flex items-center gap-3 px-3 py-2"><input id="toggle-all-companies" type="checkbox" class="w-4 h-4" ${state.activeCompanies.size === companies.length ? 'checked' : ''}/><span class="text-sm font-medium text-gray-900">Selecionar todas</span></label>` +
                companies.map(c => `<label class="flex items-center gap-3 rounded-md px-3 py-2.5 text-sm font-medium text-gray-800"><input type="checkbox" class="company-checkbox w-4 h-4" value="${c}" ${state.activeCompanies.has(c) ? 'checked' : ''}/><i data-lucide="building-2" class="w-5 h-5 text-blue-700"></i><span>${c}</span></label>`).join('');
            
            const allToggle = document.getElementById('toggle-all-companies');
            allToggle.addEventListener('change', () => {
                state.activeCompanies.clear();
                if (allToggle.checked) companies.forEach(c => state.activeCompanies.add(c));
                updateAll(); 
                updateSidebar();
            });

            filtersContainer.querySelectorAll('.company-checkbox').forEach(cb => cb.addEventListener('change', () => {
                const name = cb.value;
                if (cb.checked) state.activeCompanies.add(name); else state.activeCompanies.delete(name);
                updateAll();
                document.getElementById('toggle-all-companies').checked = companies.every(c => state.activeCompanies.has(c));
            }));
            lucide.createIcons();
        };

        const createChart = (id, type, data, options) => new Chart(document.getElementById(id).getContext('2d'), { type, data, options });
        
        const showNotification = (message, type = 'success') => {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        };

        const exportToCSV = (data, filename) => {
            if (data.length === 0) {
                showNotification('Nenhum dado para exportar', 'error');
                return;
            }
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            showNotification('Dados exportados com sucesso!');
        };

        const addLoadingState = () => { document.body.classList.add('loading'); };
        const removeLoadingState = () => { document.body.classList.remove('loading'); };
        
        document.addEventListener('DOMContentLoaded', function() {
            Chart.defaults.font.family = 'Inter';
            Chart.defaults.color = '#6b7280';
            charts.debtByType = createChart('debtByTypeChart', 'doughnut', { datasets: [{ backgroundColor: ['#1e40af', '#1d4ed8', '#2563eb', '#3b82f6', '#60a5fa', '#9ca3af', '#6b7280'], borderWidth: 4 }] }, { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } });
            charts.debtByCompany = createChart('debtByCompanyChart', 'bar', { datasets: [{ label: 'Vencido', backgroundColor: 'rgba(239, 68, 68, 0.8)', borderRadius: 2 }, { label: 'A Vencer', backgroundColor: 'rgba(245, 158, 11, 0.8)', borderRadius: 2 }] }, { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } });

            document.getElementById('filter-situacao').innerHTML = [...new Set(debitosData.map(d => d.situacao))].map(v => `<option value="${v}">${v}</option>`).join('');
            
            setupEventListeners();
            
            document.getElementById('export-btn').addEventListener('click', () => {
                addLoadingState();
                setTimeout(() => {
                    const companyFilter = (d) => state.activeCompanies.size === 0 || state.activeCompanies.has(d.empresa);
                    const situacoes = getMultiValues('filter-situacao');
                    const startDate = document.getElementById('start-date-filter').value ? new Date(document.getElementById('start-date-filter').value + 'T00:00:00') : null;
                    const endDate = document.getElementById('end-date-filter').value ? new Date(document.getElementById('end-date-filter').value + 'T23:59:59') : null;
                    
                    const dataToExport = debitosData.filter(d => 
                        companyFilter(d) &&
                        (!startDate || parseDebitosDate(d.vencimento) >= startDate) && 
                        (!endDate || parseDebitosDate(d.vencimento) <= endDate) && 
                        (situacoes.length === 0 || situacoes.includes(d.situacao))
                    );
                    
                    exportToCSV(dataToExport, 'dados_debitos.csv');
                    removeLoadingState();
                }, 500);
            });
            
            document.getElementById('refresh-btn').addEventListener('click', () => {
                addLoadingState();
                setTimeout(() => {
                    updateAll();
                    showNotification('Dados atualizados!');
                    removeLoadingState();
                }, 800);
            });

            updateSidebar();
            updateAll();
        });
    </script>
</body>
</html>
